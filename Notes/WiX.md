# WiX

## The tools in the WiX toolset

| Tool						| Executable																   |
| --------------------------|------------------------------------------------------------------------------|
| Compiler					| candle.exe = from source files *.wsx to object files.		                   |
| Linker					| light.exe	= from object files + Wix libraries to *msi or other executable.   |
| Bootstrapper, chainer,...	| burn.exe 												   |
| Harvester					| heat.exe	= used to automatice generation of source code from an existing directory structure |
| Decompiler			    | dark.exe  = from *.msi to *.wsx source code	|

### WiX in Visual Studio

Votive is the name of the Visual Studio add-in that is installed to VS by the WiX toolset to provide syntax
highlighting and intellisense support for *.wsx files and also MSI intergation and WiX project types.

--- 

### Location of the WiX Toolset and PATH

- C:\Program Files (x86)\WiX Toolset v3.10

The executables of interest are all located in the bin folder 

- C:\Program Files (x86)\WiX Toolset v3.10\bin

Precisely the executable tools __candle.exe, light.exe, heat.exe, dark.exe__ and others such as 
__insigna.exe, lux.exe, melt.exe, torch.exe__ are all directly under in the bin folder. The only 
exception is __burn.exe__.  

- C:\Program Files (x86)\WiX Toolset v3.11\bin\x86\burn.exe

--- 

### Use WiX from command line

Make sure that the location below is in the PATH variable for the user or the system

- C:\Program Files (x86)\WiX Toolset v3.10\bin  

Refere to the help for each executable tool as in the examples below.

```
> candle.exe --help  
> light.exe --help
```

---

## WiX GUIDs

- Package Code

  This uniquely identifies the *.msi package thus it must change evry time a 
  new *.msi is built from source. In summary, twi *.msi files should have the 
  same PackageCode if and only if they are identical copies! WiX takes care of
  this for you.  

- Product Code

  This uniquely identify a product on a single Windows system. Typically the 
  Product Code is only changed when the product version is changed.

- Upgrade Code

  This identifies a product line or a set of related products. The same upgrade 
  code is used for each release of a product. The Upgrade code is used to support
  the **Windows Installer Upgrade Functionality**.

  ### Major Upgrade

  When WSI detects that there is already a product with the same **Upgrade Code**
  but a lower version it replaces it with the newer version.

---

## Windows Installation Types

1. Simple

   This is the most commone case.

2. Administrative

   An ISO is installed to the Network by an administrator. Afterwards,
   users of teh network can install the ISO on their individual system
   from the shared image.

3. Advertisment

   Only the UI required to start an installation is presented to the 
   users. Only whan the user decides to continue whith the installation
   this can procede on-demand.

## Windows Installation Phases

Each installation carried out by the Windows Installer Service is performed 
in two phases and each phase is composed of actions executed in a separate 
process each with a separate set pf privileges.

1. UI Phase - Client Side Phase - Non Transactiona Phase

   The UI phase runs in a process under the identity of the user that
   started the installation. During the UI phase the system cannot be 
   modified. Any actions performed duriong the UI phase **cannot** be 
   rolled back because these are **NOT** scripted into the **rollback**
   script that is automatically generated by WSI. 

   The sequence of actions performed by WSI during the UI phase is 
   reflected in the **InstallUISequence Table**.

   The purposes of the UI phase are listed  below.

	- Collect user input i.e. which Features to install.
    - Perform...

2. Execute Phase - Server Side Phase - Transactiona Phase

   The Execute phase runs under the special account **LocalSystem** which
   as eleveted priviliges sufficient to perform the actions typical of the
   execute phase. All the actions performed during the executed phase are 
   scripted into automatically generated the rollback script produced by 
   WSI.   

### Omission of the UI phase

An *.msi can be compiled so that there is no UI phase. Furthermore, for any 
*.msi the following will run the installation without te UI phase thanks to
the flad **/q**.

```>msiexec /i /q mypackage.msi```

### Sequence of steps during an installation

A detailed description of the steps taken by WSI during installation is below.

1. [Queueing Up](https://www.firegiant.com/wix/tutorial/events-and-actions/queueing-up/)

Sequences of install operation are declared in some of the tables of the *.msi
which may collectively be named **Sequence Table Columns**. All of them share 
the same schema with three basic columns - **Action, Condition, Sequence.** 

1. **Action**  
    It can be either a standard action or a custom action.  

2. **Condition**  
   Holds an expression that determines whether the action is executed.  
   The action is executed is the condition is either blank or evaluates to true.

3. **Sequence**   
   Specifies the order in which the Windows Installer is going to execute the 
   actions.

### Steps taken in Simple installation mode

1. Client side phase
   1. InstallUISequence
   
2. Server side phase
   1. InstallExecuteSequence

### Steps taken in Administrative installation mode

1. Client side phase
   1. AdminUISequence
   
2. Server side phase
   1. AdminExecuteSequence
   
### Steps taken in Advertise installation mode

This is special when compered to the previous two modes.

1. Client side phase
   1. AdvtExecuteSequence

---

## WiX Extensions 

The WiX toolset provides a set of core services within its base assembly WiX.dll.
However, a number of additional asseblies extend the core WiX Toolset by with 
addtional markup and services. 

In order to make use of any extension in a WiX project a reference my be added in
Visual Studio to the corresponding assembly located in the bin folder of the Toolset.

- C:\Program Files (x86)\WiX Toolset v3.11\bin

##### Examples

1. [Using Standard Custom Actions](http://wixtoolset.org/documentation/manual/v3/customactions/using_standard_customactions.html)

| Extension					| Description						     					   |
| --------------------------|--------------------------------------------------------------|
| WiXUIExtension            | Provides UI services to the installer.                       |
| WiXUtilExtension          | Provides extra markup i.e. DirectorySearchRef, User etc.     |
|                           | Foe example \<User> lets the MSI set up a user account during an install |
| WixNetfxExtension   	    | Includes a set of custom actions to compile native images using Ngen.exe. |
|                           | It includes properties such as NETFRAMEWORK20 to check the .Net Framework version on the target| 
|||

---

## Standard Actions

Windows installer defines **Standard Actions** which should always be executed
during any installation run in a predesigned order. Each of the Standard Actions
has a predefined purpose. **WiX** takes care of declaring these appropriately 
when the source is built and corresponding rows are created in the *.msi tables 
for each of the necessary standard action. The number of standard actions that 
are actually present in the *.msi tables depends on the specifics of the install.

- [Standard Actions Reference](https://msdn.microsoft.com/en-us/library/windows/desktop/aa372023(v=vs.85).aspx) 

## Custom Actions

- [Custom Actions](https://msdn.microsoft.com/en-us/library/windows/desktop/aa368066(v=vs.85).aspx)  

While Standard Action are always part of the installation workflow there may be 
the need for some custom action to be executed on the target system during the
installation which are not part of teh standard workflow. 

Some illustrative examples of custom actions are the following.

- Set a property to a certain value when some run-time condition is verified or detected.
- Set a location to a specific path if a run-time condition is verified or detected.
- Invoke a function from a DLL embedded in the Binary table of the *.msi - **Type 1**.
- Launch an executable emedded in the Binary table of the *.msi -**Type 2**.
- Call a function of a DLL installed by the installer -**Type 17**.
- Call an EXE installed by the installer -**Type 18**. 
- Display an error as a formatted string to the user and terminate the installation -**Type 19**.
- Set an install directory path using a formated string - **Type35**.
- Set the value of a Windows Installer Property using a formatted string **-Type 51**.
- etc. 
 
Custom actions are made available by the Windows Installer and each custom action 
has a specific type.

- [Custom Action Types](https://msdn.microsoft.com/en-us/library/windows/desktop/aa372048(v=vs.85).aspx)  

### Deferred Execution Custom Action

- [What is Deferred Execution Custom Action and Why is it Used ?](https://www.symantec.com/connect/blogs/what-deferred-execution-custom-action-and-why-it-used)  

The purpose of a deferred execution custom action is to delay the execution of 
a system change to the time when the installation script is executed. This differs 
from a regular custom action, or a standard action, in which the installer executes 
the action immediately upon encountering it in a sequence table or in a call to 
MsiDoAction.

A deferred execution custom action enables a package author to specify system operations 
at a particular point within the execution of the installation script. The installer 
does not execute a deferred execution custom action at the time the installation sequence 
is processed. Instead the installer writes the custom action into the installation script.

- Should be placed between install initialize and install finalize.
- Does not have access to MSIDATABASE in deferred execution.

---

## Conditions

The tables of the *.msi named **Sequence Table Columns** share the same schema 
with three basic columns - **Action, Condition, Sequence.** as already described.
Whether an action is executed by the WSI or not depends upon the corresponding 
condition. A condition is an expression that can be blank or that evaluates to 
either true or false.

- The action is executed when the corresponding condition evaluates to true or is blank.
- The action is not executed otherwise.

### WiX Condition

- http://wixtoolset.org/documentation/manual/v3/xsd/wix/condition.html

The \<Condition> element in WiX is overloaded that is its semantic depends on the elemnt that 
contains the \<Condition> element. In general a condition is used to execute some custom action.

A custom action is executed when the corresponding condition expression evaluates to **true** 
otherwise the action is skipped.

In the *.msi table structure the tables **LaunchCondition** and all the **..Sequence** tables 
have a dedicated Condition column with the expression to be evaluated at run time. The 
conditions in the **LaunchCondition** table are special because on the event of any of these
evaluation to false Windows Installer shows a message to teh user and aborts the installation
process. The conditions in the **..Sequence** tables instead only determine whether the
corresponding action is going to be executed or not. 

### Conditions of Features and Components

It is also possible to set conditions on individual Features or Components which are installed 
when the corresponding condition expression evaluates to **true**. When no condition is specified
on a component or Feature the condition expression evaluates to **null** which Windows Installer
interprets as **true** thus the Component or Feature will be installed.

### Conditions in the UI of the installer

Conditions can also be used to hide or diplsay controls in the UI for the installer or to 
determine their behavior.

### Conditions with property

Often conditions are used together with properties.

#### The Installed and REMOVE properties

- [Installed property](https://msdn.microsoft.com/en-us/library/windows/desktop/aa369297(v=vs.85).aspx)
- [Searchng and Launch Conditions](https://app.pluralsight.com/player?course=wix-introduction&author=matthew-clendening&name=wix-introduction-m3&clip=8&mode=live)

The following is an examle of how a condition element is typically used. Notice that the condition is 
in the CDATA element and a custom message is provided through the Message attribute. The Message is shown
to the user **only if the condition evaluates to FALSE!**

The **Installed** property is set only if the product is installed per-machine or for the current user (locally).
The **Installed** property is often used in the \<![CDATA[Installed OR SOMEPROPERTY]]> syntax of **Launch Conditions**
to make sure that the condition always evaluates to **true** when the user runs the unistaller. In this case the product 
is already installed and **Installed** evaluates to **true** hence the condtion evaluates always to **true** and is 
never able to stop the uninstallation process. 

In the example below

- On the first install Installed is **false** thus the NETFRAMEWORK20 is checked and if false the condition
  evaluates to false and the installation is aborted because the .Net Framework 2.0 is not present on the 
  target system.

- On any subsequent install the Installed property evaluates to **true** hence the condition is never executed.

- On **unistalling** the Installed property evaluates to **true** hence the condition is never executed.

```
<Condition Message="This application requires .NET Framework 2.0. Please install the .NET Framework then run this installer again.">
    <![CDATA[Installed OR NETFRAMEWORK20]]>
</Condition>
```

Another property with the same flavour is the **REMOVE** property which is only set during unistallation.

---

### Accessing Values in Conditions

| Operator					| Example							     					   |
| --------------------------|--------------------------------------------------------------|
| Envirinmental Variable	| %EnvVarName												   |
| Component Key				| $MyComponent (Action state of component)					   |
| Component Key				| ?MyComponent (Installed state of component)				   |
| Feature Key				| &MyFeature   (Feature action state)	      		           |
| Feature Key				| !MyFeature   (Installed state of feature)				       |

- Installed State - the current state of the component of feature.
- Action State - the action planned by the WIS for the component or feature in the current istall process.

| State					    | Value | Meaning														   |
| --------------------------|-------|------------------------------------------------------------------|
| INSTALLSTATE_UNKNOWN	    |  -1   | No action for feature or component							   |
| INSTALLSTATE_ADVERTISED	|  1    | Advertise feature (not possible for components)                  |
| INSTALLSTATE_ABSENT	    |  2    | Feature or component not present   							   |
| INSTALLSTATE_LOCAL	    |  3    | Feature or component locally installed    					   |
| INSTALLSTATE_SOURCE	    |  4    | Feature or component accessed from source						   |

---

### LaunchCondition table

LaunchCondition is a special table of every *.msi. There exists a **Launch Condition 
Standard Actions** in the **InstallExecuteSequence** table that is always executed.
The **Launch Condition Standard Actions** causes all the conditions for the actions 
in the **LaunchCondition table** to be evaluated. 

**All the conditions in the LaunchCondition table must evaluate to true** in order 
for WSI to continue the installation. If this is not the case an error message is 
displayed to the user and the insallation is terminated. 

### Conditions on Features and Components

Conditions may be specified for Features and Components. A Feature or Component 
will be installed only if the corresponding condition evaluates to true or is 
blank that is it is not specified. 

### Conditional Expression Operators

The standard comparision operators can be used to compose conditional expressions.
The types alloew in such expressions are only **integer** and **string**. WSI 
enforces case sensitivity on all standard comparison operators. However, case 
sensitivity can be bypassed by prepending any of the allowed operators with the 
charcter **tilde** **~**. The logical operators **AND, OR, XOR, EQV, IMP** are 
also allowed.

#### Special strings operatos

- string1 >< string2  
   
  True only if string1 **contains** string2.

- string1 << string2

  True only if string1 **starts** with string2.

- string1 >> string2

  True only if string1 **ends** with string2.

#### Property Conditions

The name of a property may be used as a valid conditional expression.
It evaluates to true only if the name the property has been defined 
**AND** a value for the property exists!

To detect is a property has **not** been defined use the negation as
in the follwing example which evaluates to true only if the property 
has not been defined.

**NOT _MYPROPERTYNAME_**

#### Special inputs to conditional expressions

- Environment Varables %NAMEOFTHEENVVAR
- Component Key for action state $MyComponent
- Component Key for installation state ?MyComponent
- Feature Key for action state &MyFeature
- Feature Key for installation state !MyFeature

The **Action State** is the state of the Feature or Component according to 
the WSI after the current install succedes. The **install state** is the 
current state of the Feature or Component on the system.

INSTALLSTATE_UNKONWN = -1
INSTALLSTATE_ADVERTISED = 1
INSTALLSTATE_ABSENT = 2
INSTALLSTATE_LOCAL = 3
INSTALLSTATE_SOURCE = 4

#### Examples

- "A" = "a"  => false
- "A" ~= "a" => true

---
   
## Winwdows Installer built-in properties

There are several standard built-in properties that are set by the WSI during
the execution of an insatllation. These are often useful in conditional 
expressions for custom actions.

- [Property Reference](https://msdn.microsoft.com/en-us/library/windows/desktop/aa370905(v=vs.85).aspx)

#### Some notable standard properties

- Installed - Indicates that a product is already installed.
- REMOVE - set during uninstallation
- etc.

---

### Windows Installer Formatted Strings

https://www.advancedinstaller.com/user-guide/formatted.html

Windows Installer makes use of a special string type called **formatted strings** which has some
special features. Some of the tables in the *.msi have columns that are of the type **formatted 
string** the actual value of a formatted string is determined at run-time during the installation. 
In particular the evaluation of formated strings is performed by WSI only after the following three
standard actions have been executed. 

- CostInitialize
- FileCost
- CostFinalize

If any of these three standard action is skipped formatted strings are not evaluated and their 
values is set to **an empty string**.

The following can be **referenced** by formatted strings.

1. Properties
2. Folders
3. Files
4. Envirinment Variables

The following illustrates the syntax for various formatted strings.

- [propertyname]
- [DirectoryKey]
- [%environmentvariable]
- [#filekey]
- [&temporaryfile]
- [folderkey]

#### Examples

- [MYPROPERTY] is evaluated to teh value of the property of name MYPROPERTY
- [MyDirectoryKey] is evaluated to the path of the directory of key MyDirectoryKey
- [#myfilekey] is evaluated to the full path to the file bound to the key myfilekey
- etc.

#### Composing formatted strings

Formatted strings may be composed using the syntax illustrated below where the whole 
formatted strings is bracketed within curly brackets \{}.

- {The property evaluates to [MYPROPERTY] and the file path is [#FileKey]}

#### Escaping literals in formatted strings

Characters can be escaped by prefixing them with a backslash \.

- {This is a backslash \\}
- []

---

## The msiexec

The Windows Installation Service can be invoked to perform the operations 
declared in any *.msi package from command line as described in the 
following or just by double clicking on the *.msi.

### Help
```>msiexec /?```  

### Installing a package

```>msiexec /i mypackage.msi```
```>msiexec /i /quiet mypackage.msi```

### Uninstalling a package 

```>msiexec /x mypackage.msi```    
```>msiexec /x {{PRODUCT CODE}}```

### Installing a Feature of a Package

```>msiexec /i mypackage.msi ADDLOCAL=FEATURE_ID```

### How to run an MSI with logging 

In order to produce an event log during of the operations performed by the
installer for a specific ```*.msi``` the flag __l*v__ must be provided to 
the __msiexec__. The destination file is always a plain text file which can
be named anything like log.text or log.log or similar. With the /L*v or /L*vx
flags the log file may become very large but it can be useful to debug the 
installation.

In the log there are all the sequential actions performed by the WIS as instructed
by the *.msi. These action are bracketed by **Action...Start**, **Action...Ended**
or similar. Each action completes with a return value reporting the state after the
execution of the action.


#### Basic logging information   
```>msiexec /i myInstaller.msi /l log.log```  

#### Verbose mode logging
```>msiexec /i myInstaller.msi /l*v log.log```

#### Verbose mode logging with additional debugging info
```>msiexec /i myInstaller.msi /l*vx log.log```

--- 

## Structure of an install log file

### Action Return Values

|Action Return Value		| Meaning|						|
| --------------------------|--------------------------------------------------------------|
| 0							| Function could not be executed i.e. there was nothing to do  |
| 1							| Success|
| 2							| User cancelled installation|
| 3							| Fatal error|
| 4							| Installation suspended| 

### The format of a log entry

MSI (x) (XY:WZ) [time stamp] : log Message or Notes...

### The installation phases

|Prefix						| Meaning|						|
| --------------------------|--------------------------------------------------------------|
| MSI (c)				    | client side phase  |
| MSI (s)				    | server side phase  | 

- The **client side phase** is where the installer UI is executed.
- The **server side phase** is where system changes are performed.

### Execution Processes

The **(XY:WZ)** identifiles the **ProcessID:ThreadID** of the executed action.
The MSI (c) and MSI (s) are executed in **separate processes**.

### Interpreting logged Notes

Logged notes are organized in **parts** where the number, the order and meaning of each part 
depends on the first part which is always the error code. Error codes are described online 
or can be queried form command line as long as the **COM Error Code** is used in the query.
The **COM Error Code** is the hexadecimal standard DWORD for the decimal error code - the 
Windows calculator may be used to convert.

```>net helpmsg [COM Error Code]```

#### Notes parts

- part 1: Error Code => https://msdn.microsoft.com/en-us/library/windows/desktop/aa372835(v=vs.85).aspx  
- part 2: ...   
- part 3: ...  

### Tips on how to use a log file to debug installs

There are a number of simple techniques which can be employed to 
investigate problems with installs. These are mostly based on 
searching for specific tokes present in the log file.

1. Search the log file for **actions** that may have **returned a value of 3** 
   which signal **errors**. 
2. Search for the **Feature** keywords. These should be the start of the actions 
   executed to install the components.
3. Search for the keyword **FileCopy** which signal the action of files
   being copied to the file system.

---

### Turning on the Windows Installer Global Logging

It might be possible to encounter situations whereby **msiexec** cannot be run with 
logging on a specific *.msi. It is possible to enable WSI logging on the machine in
such cases as illustrated here.

1. [How to enable Windows Installer logging](https://support.microsoft.com/en-gb/help/223300/how-to-enable-windows-installer-logging)  

---

### WiX extensions as Windows  Installer Custom Actions

- SQL configuration
- ISS configuration
- etc..

---

### How To: Create a Shortcut on the Start Menu

1. [How To: Create a Shortcut on the Start Menu](http://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/create_start_menu_shortcut.html)  

---

### ICE Errors and Warnings - Internal Consistency Evaluators

ICE codes reflect the outcome of consistency checks carried out on *.msi packages to 
determine the structural consistency of its tables. 

1. [Wix - ICE60 and ICE69 warnings](https://stackoverflow.com/questions/21320334/wix-ice60-and-ice69-warnings)  
   The cleanest way to handle ICE69 which may be recurrent is to just leave them in the build output and ignore 
   them where and when it makes sense.

---

## Windows installer technology basics

1. The Windows installer is a background service of the OS aimed to maintain system stability.
2. The Windows installer performs transactional operations that is they can be rolled back. 
3. During an installation a roll-back script is automatically generated.
4. The roll-back stcript is run on cancellation of the install or on failure.
5. Windows installer includes **Self-Repair**. This allows to restore assets of an install from the cached installation source. 
6. Provides the assemblies for the installer UI with a standard set of controls.
7. It provides **standard actions** as well as **custom actions**.
8. It provides registration with the tool **Programs and Features**.
9. It provides **Upgrades and Patching** features.
10. It provides the installation logging service.

## MSI

With the Windows installer technology the *.msi package is part of the **declarative** approach
to installation functinality. This is in contrast to the **scripted of procedural** approach used
in the past of by other thrid-party technologies.

The declarative apporach is superior because the Windows Installation Service can be guaranteed
to be 100% correct. The provider of the *.msi only provides the data and not the operational
logic.

1. *.msi files are Windows installation packages and they comprise data streams and ad database.
2. *.msi are consumed by the Windows Installer Service which performs the actions described in the *.msi with the provided data.

---

## Tools

1. **Orca** is an **MSI Viewer** from the Windows SDK.
2. **InsteEd** is another **MSI Viewer** similar to **Orca** but with added capabilities such *.msi compare. 
3. The tools from **Windows Sysinternals** which can all be downloaded from https://live.sysinternals.com/.

---

## WiX Notes 

### File

1. The **vital** attribute on a File element instructs WSI to continue the installation
   even when an error was detected while trying to copy the file to disc. The defaule of
   **vital** is **yes**. If a vital file fails to be copied to disc the user is propmpt 
   for a retry or to stop the installation.

2. The **ReadOnly** attribute causes the file to be **read-only** on the target system.

3. The **Hidden** attribute causes the file to be **hidden** on the target system.

---
### Feature

```
<Feature Id="FEATURE_LOGXTREME_WIN_DSK"
				Title="LogXtreme Data Logger Software for Windows Desktop"
				Description="Installs LogXtreme Data Logger Software for Windows Desktop"
				Level="1">
		<ComponentRef Id="CMP_LOGXTREME_WIN_DSK_EXE"/>
		<ComponentRef Id="CMP_APPLICATION_SHORTCUTS"/>
</Feature>	  
```  


- Features contains sets of components
- Features can be visible to the users in the installer UI
- Components cannot be visible to the users in the installer
- Title and Description shows in the UI whan available
- Level=1 means the Feature is set to be installed locally*
- Level=0 means the Feature is disabled and is not displayed in the UI or installed*
    
The Windows Installer Propety **InstallLevel** sets the threshold for the **Level** of 
the Features that will be installed and its default value is 1. A Feature is installed when 
its attribute **Level** is set to a value such that **Level <= InstallLevel**. 

This causes all Features with Level set to 1 to be installed. However, the Features with 
Level set to 0 will not be installed and will not be visible in the UI. 

### Main Feature

#### Make sure that the Main Feature is installed

Any *.msi should have a main Feature and it must be impossible for the user to avoid
the installation of the product without installing the main feature i.e. when the 
*.msi has UI support it must be impossible for the user to disable the installation 
of the main Feature via the UI of the installer. This can be doen by setting the 
following attribute on the Feature elements that must be installed in all cases. 

**Absent="disallow"**

#### Disable the Advertised Mode on the Main Feature

Advertised Features are not physically installed on the target system until the user 
actually launches them. In some cases this might be useful but it is normally not the
appropriate installation mode for crutial features of the application being installed.

Often the Main Feature should be installed directly from the *.msi as non advertised. 
Use the floowing attribute on the Feature elements that should not be provided as 
advertised on the target system.

**AllowAdvertise="no"**

---

## WiX UI Extension

In order to provide the installer package *.msi with **basic UI** support any WiX project
may set a reference to the folloeing library directly from Visual Studio.

```C:\Program Files (x86)\WiX Toolset v3.11\bin\WixUIExtension.dll```

This library provides a number of prepackaged UI options.

- WixUI_Minimal
- WixUI_Advanced
- WixUI_FeatureTree
- WixUI_InstallDir
- WixUI_Mondo

After the project reference to the **WixUIExtension.dll** is set the following element 
must be added to **Product.wxs** as a child of the Product element.

```
<!--
- WixUI_Minimal
- WixUI_Advanced
- WixUI_FeatureTree
- WixUI_InstallDir
- WixUI_Mondo
-->
<UIRef Id="WixUI_Minimal" />
```

### Custom Lincence Agreement

The WiX UI support in its simple form **WixUI_Minimal** may be used to install a 
single feature and present teh user with the **Licence Agreement**. In order to 
include a custom Licence Agreement document..

```
<WixVariable Id="WixUILicenseRtf" Value="test.rtf" />
```

#### Fix the issue with *.rtf and WiX

The installer might have problems with displaying the *.rtf correctly in which 
case it might be required to open the file in WordPad and resaved it as *.rtf
to clean up the special formatting left over by Words or similar.

- [wix specify licence shows nothing
](https://stackoverflow.com/questions/6380724/wix-specify-licence-shows-nothing)

---

## AppSearch & LaunchConditions

AppSearch is the part of Windows Installer that allows to examine the 
target system. AppSearch is a Windows Installer **standard action** and
the WiX Toolset provides access to this functionality. 

- Files
- Folders
- Registry Keys

### AppSearch with Wix

The WiX Toolset provides a set of tags to performed some of teh common 
searches allowed by the Windows Installer AppSerch.

- \<DirectorySearch>
- \<FileSearch>
- \<RegistrySearch>
- \<ComponentSearch>
- \<IniSearch>

#### RegitrySearch

- [How To: Read a Registry Entry During Installation](http://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/read_a_registry_entry.html)
- [RegistrySearch Element](http://wixtoolset.org/documentation/manual/v3/xsd/wix/registrysearch.html)
- [Registry Search](https://app.pluralsight.com/player?course=wix-introduction&author=matthew-clendening&name=wix-introduction-m3&clip=11&mode=live)

##### Example - registry search for a raw value

- [How To: Write a Registry Entry During Installation](http://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/write_a_registry_entry.html)

The sample below will set the NETFRAMEWORK20 property to "#1" if the registry key was found, 
and to nothing if it wasn't. Notice that this code is just an example to illustrate how to
use the RegistrySearch, in reality the definition of NETFRAMEWORK20 and other very useful 
property can be more conveniently be left to WiX which provides this properties in the extension
**WixNetfxExtension**.


In this example Type="raw" that is the value stored for the key is a number and no prefix or 
suffix is expetced. However, for other types this might not be the case as explained next.

```
<Property Id="NETFRAMEWORK20">
    <RegistrySearch Id="NetFramework20"
                    Root="HKLM"
                    Key="Software\Microsoft\NET Framework Setup\NDP\v2.0.50727"
                    Name="Install"
                    Type="raw" />
</Property>
```

##### Example - registry search for a file or path

```
<Property Id="MY_PROPERTY">
	<RegistrySearch Id="myRegSearch"
					  Root="HKLM"
					  Key="SOFTWARE\WIXTEST"
					  Name="PathToFile"
					  Type="file">
		<FileSearch Id="myFileSearch" 
				  Name="[MY_PROPERTY]" />
	</RegistrySearch>
</Property>
```

Suppose you want to read a value from the Registry and that value is the path to a
file. You then want to check that the file is truly where it says it is on the filesystem.
As an example, assume that there's a Registry item HKLM\SOFTWARE\WIXTEST\PathToFile that's 
set to the value C:\Program Files\mySoftware\myFile.txt. You can get this value from the 
Registry by using the RegistrySearch element. Here, the RegistrySearch element finds the 
item in the Registry and sets the value of MY_PROPERTY. Next, the nested FileSearch element 
can now read that property and use it to find the file on the computer. If it finds it, it 
replaces the value of MY_PROPERTY with the location of the file which should be the same.
If it doesn't find it, it sets the value to null.

In order for this to work, you have to set the RegistrySearch element's Type
attribute to file. This tells the installer that it should expect to find the path to a
file in the Registry and that you intend to nest a FileSearch element inside the
RegistrySearch.

You can do something similar with DirectorySearch.

```
<Property Id="MY_PROPERTY">
	<RegistrySearch Id="myRegSearch"
					  Root="HKLM"
					  Key="SOFTWARE\WIXTEST"
					  Name="PathToDirectory"
				      Type="directory">
	<DirectorySearch Id="myDirSearch"
					   Path="[MY_PROPERTY]" />
	</RegistrySearch>
</Property>
```

Here, Type is set to directory allowing you to nest a DirectorySearch element
inside RegistrySearch. This type also tells the installer that it should expect the
Registry value to hold the path to a directory. Like the FileSearch example, this
one uses the RegistrySearch result to set a property and then uses that property to
search the filesystem. This time, it's looking for a directory instead of a file. If it finds
it, it will set the property to the path. If not, the property will be set to null.

##### Added prefixes for raw

When reading values from the registry with RegistryKey with attribute Type="raw" the 
following data type may be possible.

| Registry Data Type | Prefix                                                       |
| -------------------|--------------------------------------------------------------|
| REG_SZ			 | None - if 1st char is '#' it is escaped with another '#'     |
| REG_MULTI_SZ		 | Begins with '[ ~ ]' and ends with '[ ~ ]'                    |
| REG_EXPAND_SZ		 | Begins with '#%'							                    |
| REG_BINARY		 | Begins with '#x' and each hex digit is also prefixed by '#x' |
| DWORD      		 | Begins with '#' opionally followed by '+' or '-'             |


### LaunchConditions


- https://blogs.technet.microsoft.com/alexshev/2008/02/10/from-msi-to-wix-part-3-launch-conditions-and-application-search/
- https://stackoverflow.com/questions/7389414/how-to-determine-the-folder-that-a-previous-wix-install-installed-a-program-in
- https://blogs.msdn.microsoft.com/syamp/2012/09/30/wix-search-for-install-path-from-registry/
- 
One of the many ways that the results for the standard action AppSearch
can be used is in a LaunchCondition. LaunchConditions are evaluated at the
beginning of the set-ip process just after AppSearch.

Normally LaunchConditions are used to test whether the target system 
satisfies **required prerequisites**.

- If a LaunchCondition retuns false then a message dialog is displayed 
  to the user and the installation is terminated.
---

## WiX Topics

1. [Where to Install?](https://www.firegiant.com/wix/tutorial/getting-started/where-to-install/)
1. [How To: Block Installation Based on OS Version](http://wixtoolset.org/documentation/manual/v3/howtos/redistributables_and_install_checks/block_install_on_os.html)
2. [How To: Read a Registry Entry During Installation + Use the property in a condition](http://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/read_a_registry_entry.html) 
3. [How To: Check for .NET Framework Versions](http://wixtoolset.org/documentation/manual/v3/howtos/redistributables_and_install_checks/check_for_dotnet.html)
4. [How to implement WiX installer upgrade?](https://stackoverflow.com/questions/114165/how-to-implement-wix-installer-upgrade)
5. [Wix/MSI - How to avoid installing same MSI twice](https://stackoverflow.com/questions/7656509/wix-msi-how-to-avoid-installing-same-msi-twice) 
6. [How To: Write a Registry Entry During Installation](http://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/write_a_registry_entry.html)

---

## Other useful Info

1. [How do I find the .NET version?](https://stackoverflow.com/questions/1565434/how-do-i-find-the-net-version)

The Powershell command below is to run under admin account and returs the complete table of .NET Frameworks
installed on teh system includiong things such as WCF and WPF amongst the other.

```
 gci 'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP' -recurse | gp -name Version,Release -EA 0 |
     where { $_.PSChildName -match '^(?!S)\p{L}'} | select PSChildName, Version, Release
```

---

