# WiX

## The tools in the WiX toolset

| Tool						| Executable																   |
| --------------------------|------------------------------------------------------------------------------|
| Compiler					| candle.exe = from source files *.wsx to object files.		                   |
| Linker					| light.exe	= from object files + Wix libraries to *msi or other executable.   |
| Bootstrapper, chainer,...	| burn.exe 												   |
| Harvester					| heat.exe	= used to automatice generation of source code from an existing directory structure |
| Decompiler			    | dark.exe  = from *.msi to *.wsx source code	|

### WiX in Visual Studio

Votive is the name of the Visual Studio add-in that is installed to VS by the WiX toolset to provide syntax
highlighting and intellisense support for *.wsx files and also MSI intergation and WiX project types.

--- 

### Location of the WiX Toolset and PATH

- C:\Program Files (x86)\WiX Toolset v3.10

The executables of interest are all located in the bin folder 

- C:\Program Files (x86)\WiX Toolset v3.10\bin

Precisely the executable tools __candle.exe, light.exe, heat.exe, dark.exe__ and others such as 
__insigna.exe, lux.exe, melt.exe, torch.exe__ are all directly under in the bin folder. The only 
exception is __burn.exe__.  

- C:\Program Files (x86)\WiX Toolset v3.11\bin\x86\burn.exe

--- 

### Use WiX from command line

Make sure that the location below is in the PATH variable for the user or the system

- C:\Program Files (x86)\WiX Toolset v3.10\bin  

Refere to the help for each executable tool as in the examples below.

```
> candle.exe --help  
> light.exe --help
```

---

## WiX GUIDs

- Package Code

  This uniquely identifies the *.msi package thus it must change evry time a 
  new *.msi is built from source. In summary, twi *.msi files should have the 
  same PackageCode if and only if they are identical copies! WiX takes care of
  this for you.  

- Product Code

  This uniquely identify a product on a single Windows system. Typically the 
  Product Code is only changed when the product version is changed.

- Upgrade Code

  This identifies a product line or a set of related products. The same upgrade 
  code is used for each release of a product. The Upgrade code is used to support
  the **Windows Installer Upgrade Functionality**.

  ### Major Upgrade

  When WSI detects that there is already a product with the same **Upgrade Code**
  but a lower version it replaces it with the newer version.

---

## Windows Installation Types

1. Simple

   This is the most commone case.

2. Administrative

   An ISO is installed to the Network by an administrator. Afterwards,
   users of teh network can install the ISO on their individual system
   from the shared image.

3. Advertisment

   Only the UI required to start an installation is presented to the 
   users. Only whan the user decides to continue whith the installation
   this can procede on-demand.

## Windows Installation Phases

Each installation carried out by the Windows Installer Service is performed 
in two phases and each phase is composed of actions executed in a separate 
process each with a separate set pf privileges.

1. UI Phase - Client Side Phase - Non Transactiona Phase

   The UI phase runs in a process under the identity of the user that
   started the installation. During the UI phase the system cannot be 
   modified. Any actions performed duriong the UI phase **cannot** be 
   rolled back because these are **NOT** scripted into the **rollback**
   script that is automatically generated by WSI. 

   The sequence of actions performed by WSI during the UI phase is 
   reflected in the **InstallUISequence Table**.

   The purposes of the UI phase are listed  below.

	- Collect user input i.e. which Features to install.
    - Perform...

2. Execute Phase - Server Side Phase - Transactiona Phase

   The Execute phase runs under the special account **LocalSystem** which
   as eleveted priviliges sufficient to perform the actions typical of the
   execute phase. All the actions performed during the executed phase are 
   scripted into automatically generated the rollback script produced by 
   WSI.   

### Omission of the UI phase

An *.msi can be compiled so that there is no UI phase. Furthermore, for any 
*.msi the following will run the installation without te UI phase thanks to
the flad **/q**.

```>msiexec /i /q mypackage.msi```

### Sequence of steps during an installation

A detailed description of the steps taken by WSI during installation is below.

1. [Queueing Up](https://www.firegiant.com/wix/tutorial/events-and-actions/queueing-up/)

Sequences of install operation are declared in some of the tables of the *.msi
which may collectively be named **Sequence Table Columns**. All of them share 
the same schema with three basic columns - **Action, Condition, Sequence.** 

1. **Action**  
    It can be either a standard action or a custom action.  

2. **Condition**  
   Holds an expression that determines whether the action is executed.  
   The action is executed is the condition is either blank or evaluates to true.

3. **Sequence**   
   Specifies the order in which the Windows Installer is going to execute the 
   actions.

### Steps taken in Simple installation mode

1. Client side phase
   1. InstallUISequence
   
2. Server side phase
   1. InstallExecuteSequence

### Steps taken in Administrative installation mode

1. Client side phase
   1. AdminUISequence
   
2. Server side phase
   1. AdminExecuteSequence
   
### Steps taken in Advertise installation mode

This is special when compered to the previous two modes.

1. Client side phase
   1. AdvtExecuteSequence

---

## Standard Actions

Windows installer defines **Standard Actions** which should always be executed
during any installation run in a predesigned order. Each of the Standard Actions
has a predefined purpose. **WiX** takes care of declaring these appropriately 
when the source is built and corresponding rows are created in the *.msi tables 
for each of the necessary standard action. The number of standard actions that 
are actually present in the *.msi tables depends on the specifics of the install.

- [Standard Actions Reference](https://msdn.microsoft.com/en-us/library/windows/desktop/aa372023(v=vs.85).aspx) 

## Custom Actions

- [Custom Actions](https://msdn.microsoft.com/en-us/library/windows/desktop/aa368066(v=vs.85).aspx)  

While Standard Action are always part of the installation workflow there may be 
the need for some custom action to be executed on the target system during the
installation which are not part of teh standard workflow. 

Some illustrative examples of custom actions are the following.

- Set a property to a certain value when some run-time condition is verified or detected.
- Set a location to a specific path if a run-time condition is verified or detected.
- Invoke a function from a DLL embedded in the Binary table of the *.msi - **Type 1**.
- Launch an executable emedded in the Binary table of the *.msi -**Type 2**.
- Call a function of a DLL installed by the installer -**Type 17**.
- Call an EXE installed by the installer -**Type 18**. 
- Display an error as a formatted string to the user and terminate the installation -**Type 19**.
- Set an install directory path using a formated string - **Type35**.
- Set the value of a Windows Installer Property using a formatted string **-Type 51**.
- etc. 
 
Custom actions are made available by the Windows Installer and each custom action 
has a specific type.

- [Custom Action Types](https://msdn.microsoft.com/en-us/library/windows/desktop/aa372048(v=vs.85).aspx)  

### Deferred Execution Custom Action

- [What is Deferred Execution Custom Action and Why is it Used ?](https://www.symantec.com/connect/blogs/what-deferred-execution-custom-action-and-why-it-used)  

The purpose of a deferred execution custom action is to delay the execution of 
a system change to the time when the installation script is executed. This differs 
from a regular custom action, or a standard action, in which the installer executes 
the action immediately upon encountering it in a sequence table or in a call to 
MsiDoAction.

A deferred execution custom action enables a package author to specify system operations 
at a particular point within the execution of the installation script. The installer 
does not execute a deferred execution custom action at the time the installation sequence 
is processed. Instead the installer writes the custom action into the installation script.

- Should be placed between install initialize and install finalize.
- Does not have access to MSIDATABASE in deferred execution.

---

## Conditions

The tables of the *.msi named **Sequence Table Columns** share the same schema 
with three basic columns - **Action, Condition, Sequence.** as already described.
Whether an action is executed by the WSI or not depends upon the corresponding 
condition. A condition is an expression that can be blank or that evaluates to 
either true or false.

- The action is executed when the corresponding condition evaluates to true or is blank.
- The action is not executed otherwise.

### LaunchCondition table

LaunchCondition is a special table of every *.msi. There exists a **Launch Condition 
Standard Actions** in the **InstallExecuteSequence** table that is always executed.
The **Launch Condition Standard Actions** causes all the conditions for the actions 
in the **LaunchCondition table** to be evaluated. 

**All the conditions in the LaunchCondition table must evaluate to true** in order 
for WSI to continue the installation. If this is not the case an error message is 
displayed to the user and the insallation is terminated. 

### Conditions on Features and Components

Conditions may be specified for Features and Components. A Feature or Component 
will be installed only if the corresponding condition evaluates to true or is 
blank that is it is not specified. 

### Conditional Expression Operators

The standard comparision operators can be used to compose conditional expressions.
The types alloew in such expressions are only **integer** and **string**. WSI 
enforces case sensitivity on all standard comparison operators. However, case 
sensitivity can be bypassed by prepending any of the allowed operators with the 
charcter **tilde** **~**. The logical operators **AND, OR, XOR, EQV, IMP** are 
also allowed.

#### Special strings operatos

- string1 >< string2  
   
  True only if string1 **contains** string2.

- string1 << string2

  True only if string1 **starts** with string2.

- string1 >> string2

  True only if string1 **ends** with string2.

#### Property Conditions

The name of a property may be used as a valid conditional expression.
It evaluates to true only if the name the property has been defined 
**AND** a value for the property exists!

To detect is a property has **not** been defined use the negation as
in the follwing example which evaluates to true only if the property 
has not been defined.

**NOT _MYPROPERTYNAME_**

#### Special inputs to conditional expressions

- Environment Varables %NAMEOFTHEENVVAR
- Component Key for action state $MyComponent
- Component Key for installation state ?MyComponent
- Feature Key for action state &MyFeature
- Feature Key for installation state !MyFeature

The **Action State** is the state of the Feature or Component according to 
the WSI after the current install succedes. The **install state** is the 
current state of the Feature or Component on the system.

INSTALLSTATE_UNKONWN = -1
INSTALLSTATE_ADVERTISED = 1
INSTALLSTATE_ABSENT = 2
INSTALLSTATE_LOCAL = 3
INSTALLSTATE_SOURCE = 4

#### Examples

- "A" = "a"  => false
- "A" ~= "a" => true

---
   
## Winwdows Installer built-in properties

There are several standard built-in properties that are set by the WSI during
the execution of an insatllation. These are often useful in conditional 
expressions for custom actions.

- [Property Reference](https://msdn.microsoft.com/en-us/library/windows/desktop/aa370905(v=vs.85).aspx)

#### Some notable standard properties

- Installed - Indicates that a product is already installed.
- REMOVE - set during uninstallation
- etc.

---

### Windows Installer Formatted Strings

https://www.advancedinstaller.com/user-guide/formatted.html

Windows Installer makes use of a special string type called **formatted strings** which has some
special features. Some of the tables in the *.msi have columns that are of the type **formatted 
string** the actual value of a formatted string is determined at run-time during the installation. 
In particular the evaluation of formated strings is performed by WSI only after the following three
standard actions have been executed. 

- CostInitialize
- FileCost
- CostFinalize

If any of these three standard action is skipped formatted strings are not evaluated and their 
values is set to **an empty string**.

The following can be **referenced** by formatted strings.

1. Properties
2. Folders
3. Files
4. Envirinment Variables

The following illustrates the syntax for various formatted strings.

- [propertyname]
- [DirectoryKey]
- [%environmentvariable]
- [#filekey]
- [&temporaryfile]
- [folderkey]

#### Examples

- [MYPROPERTY] is evaluated to teh value of the property of name MYPROPERTY
- [MyDirectoryKey] is evaluated to the path of the directory of key MyDirectoryKey
- [#myfilekey] is evaluated to the full path to the file bound to the key myfilekey
- etc.

#### Composing formatted strings

Formatted strings may be composed using the syntax illustrated below where the whole 
formatted strings is bracketed within curly brackets \{}.

- {The property evaluates to [MYPROPERTY] and the file path is [#FileKey]}

#### Escaping literals in formatted strings

Characters can be escaped by prefixing them with a backslash \.

- {This is a backslash \\}
- []

---

## The msiexec

The Windows Installation Service can be invoked to perform the operations 
declared in any *.msi package from command line as described in the 
following or just by double clicking on the *.msi.

### Help
```>msiexec /?```  

### Installing a package

```>msiexec /i mypackage.msi```
```>msiexec /i /quiet mypackage.msi```

### Uninstalling a package 

```>msiexec /x mypackage.msi```    
```>msiexec /x {{PRODUCT CODE}}```

### Installing a Feature of a Package

```>msiexec /i mypackage.msi ADDLOCAL=FEATURE_ID```

### How to run an MSI with logging 

In order to produce an event log during of the operations performed by the
installer for a specific ```*.msi``` the flag __l*v__ must be provided to 
the __msiexec__. The destination file is always a plain text file which can
be named anything like log.text or log.log or similar. With the /L*v or /L*vx
flags the log file may become very large but it can be useful to debug the 
installation.

In the log there are all the sequential actions performed by the WIS as instructed
by the *.msi. These action are bracketed by **Action...Start**, **Action...Ended**
or similar. Each action completes with a return value reporting the state after the
execution of the action.


#### Basic logging information   
```>msiexec /i myInstaller.msi /l log.log```  

#### Verbose mode logging
```>msiexec /i myInstaller.msi /l*v log.log```

#### Verbose mode logging with additional debugging info
```>msiexec /i myInstaller.msi /l*vx log.log```

--- 

## Structure of an install log file

### Action Return Values

|Action Return Value		| Meaning|						|
| --------------------------|--------------------------------------------------------------|
| 0							| Function could not be executed i.e. there was nothing to do  |
| 1							| Success|
| 2							| User cancelled installation|
| 3							| Fatal error|
| 4							| Installation suspended| 

### The format of a log entry

MSI (x) (XY:WZ) [time stamp] : log Message or Notes...

### The installation phases

|Prefix						| Meaning|						|
| --------------------------|--------------------------------------------------------------|
| MSI (c)				    | client side phase  |
| MSI (s)				    | server side phase  | 

- The **client side phase** is where the installer UI is executed.
- The **server side phase** is where system changes are performed.

### Execution Processes

The **(XY:WZ)** identifiles the **ProcessID:ThreadID** of the executed action.
The MSI (c) and MSI (s) are executed in **separate processes**.

### Interpreting logged Notes

Logged notes are organized in **parts** where the number, the order and meaning of each part 
depends on the first part which is always the error code. Error codes are described online 
or can be queried form command line as long as the **COM Error Code** is used in the query.
The **COM Error Code** is the hexadecimal standard DWORD for the decimal error code - the 
Windows calculator may be used to convert.

```>net helpmsg [COM Error Code]```

#### Notes parts

- part 1: Error Code => https://msdn.microsoft.com/en-us/library/windows/desktop/aa372835(v=vs.85).aspx  
- part 2: ...   
- part 3: ...  

### Tips on how to use a log file to debug installs

There are a number of simple techniques which can be employed to 
investigate problems with installs. These are mostly based on 
searching for specific tokes present in the log file.

1. Search the log file for **actions** that may have **returned a value of 3** 
   which signal **errors**. 
2. Search for the **Feature** keywords. These should be the start of the actions 
   executed to install the components.
3. Search for the keyword **FileCopy** which signal the action of files
   being copied to the file system.

---

### Turning on the Windows Installer Global Logging

It might be possible to encounter situations whereby **msiexec** cannot be run with 
logging on a specific *.msi. It is possible to enable WSI logging on the machine in
such cases as illustrated here.

1. [How to enable Windows Installer logging](https://support.microsoft.com/en-gb/help/223300/how-to-enable-windows-installer-logging)  

---

### WiX extensions as Windows  Installer Custom Actions

- SQL configuration
- ISS configuration
- etc..

---

### How To: Create a Shortcut on the Start Menu

1. [How To: Create a Shortcut on the Start Menu](http://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/create_start_menu_shortcut.html)  

---

### ICE Errors and Warnings - Internal Consistency Evaluators

ICE codes reflect the outcome of consistency checks carried out on *.msi packages to 
determine the structural consistency of its tables. 

1. [Wix - ICE60 and ICE69 warnings](https://stackoverflow.com/questions/21320334/wix-ice60-and-ice69-warnings)  
   The cleanest way to handle ICE69 which may be recurrent is to just leave them in the build output and ignore 
   them where and when it makes sense.

---

## Windows installer technology basics

1. The Windows installer is a background service of the OS aimed to maintain system stability.
2. The Windows installer performs transactional operations that is they can be rolled back. 
3. During an installation a roll-back script is automatically generated.
4. The roll-back stcript is run on cancellation of the install or on failure.
5. Windows installer includes **Self-Repair**. This allows to restore assets of an install from the cached installation source. 
6. Provides the assemblies for the installer UI with a standard set of controls.
7. It provides **standard actions** as well as **custom actions**.
8. It provides registration with the tool **Programs and Features**.
9. It provides **Upgrades and Patching** features.
10. It provides the installation logging service.

## MSI

With the Windows installer technology the *.msi package is part of the **declarative** approach
to installation functinality. This is in contrast to the **scripted of procedural** approach used
in the past of by other thrid-party technologies.

The declarative apporach is superior because the Windows Installation Service can be guaranteed
to be 100% correct. The provider of the *.msi only provides the data and not the operational
logic.

1. *.msi files are Windows installation packages and they comprise data streams and ad database.
2. *.msi are consumed by the Windows Installer Service which performs the actions described in the *.msi with the provided data.

---

## Tools

1. **Orca** is an **MSI Viewer** from the Windows SDK.
2. **InsteEd** is another **MSI Viewer** similar to **Orca** but with added capabilities such *.msi compare. 
3. The tools from **Windows Sysinternals** which can all be downloaded from https://live.sysinternals.com/.

---

## WiX Notes 

### File

1. The **vital** attribute on a File element instructs WSI to continue the installation
   even when an error was detected while trying to copy the file to disc. The defaule of
   **vital** is **yes**. If a vital file fails to be copied to disc the user is propmpt 
   for a retry or to stop the installation.

2. The **ReadOnly** attribute causes the file to be **read-only** on the target system.

3. The **Hidden** attribute causes the file to be **hidden** on the target system.

---
### Feature

```
<Feature Id="FEATURE_LOGXTREME_WIN_DSK"
				Title="LogXtreme Data Logger Software for Windows Desktop"
				Description="Installs LogXtreme Data Logger Software for Windows Desktop"
				Level="1">
		<ComponentRef Id="CMP_LOGXTREME_WIN_DSK_EXE"/>
		<ComponentRef Id="CMP_APPLICATION_SHORTCUTS"/>
</Feature>	  
```  


- Features contains sets of components
- Features can be visible to the users in the installer UI
- Components cannot be visible to the users in the installer
- Title and Description shows in the UI whan available
- Level=1 means the Feature is set to be installed locally*
- Level=0 means the Feature is disabled and is not displayed in the UI or installed*
    
The Windows Installer Propety **InstallLevel** sets the threshold for the **Level** of 
the Features that will be installed and its default value is 1. A Feature is installed when 
its attribute **Level** is set to a value such that **Level <= InstallLevel**. 

This causes all Features with Level set to 1 to be installed. However, the Features with 
Level set to 0 will not be installed and will not be visible in the UI. 

### Main Feature

#### Make sure that the Main Feature is installed

Any *.msi should have a main Feature and it must be impossible for the user to avoid
the installation of the product without installing the main feature i.e. when the 
*.msi has UI support it must be impossible for the user to disable the installation 
of the main Feature via the UI of the installer. This can be doen by setting the 
following attribute on the Feature elements that must be installed in all cases. 

**Absent="disallow"**

#### Disable the Advertised Mode on the Main Feature

Advertised Features are not physically installed on the target system until the user 
actually launches them. In some cases this might be useful but it is normally not the
appropriate installation mode for crutial features of the application being installed.

Often the Main Feature should be installed directly from the *.msi as non advertised. 
Use the floowing attribute on the Feature elements that should not be provided as 
advertised on the target system.

**AllowAdvertise="no"**

---

## WiX UI Extension

In order to provide the installer package *.msi with **basic UI** support any WiX project
may set a reference to the folloeing library directly from Visual Studio.

```C:\Program Files (x86)\WiX Toolset v3.11\bin\WixUIExtension.dll```

This library provides a number of prepackaged UI options.

- WixUI_Minimal
- WixUI_Advanced
- WixUI_FeatureTree
- WixUI_InstallDir
- WixUI_Mondo

After the project reference to the **WixUIExtension.dll** is set the following element 
must be added to **Product.wxs** as a child of the Product element.

```
<!--
- WixUI_Minimal
- WixUI_Advanced
- WixUI_FeatureTree
- WixUI_InstallDir
- WixUI_Mondo
-->
<UIRef Id="WixUI_Minimal" />
```

### Custom Lincence Agreement

The WiX UI support in its simple form **WixUI_Minimal** may be used to install a 
single feature and present teh user with the **Licence Agreement**. In order to 
include a custom Licence Agreement document..

- [wix specify licence shows nothing
](https://stackoverflow.com/questions/6380724/wix-specify-licence-shows-nothing)

---